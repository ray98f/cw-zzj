<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="ie-stand">
    <style>
        input::-ms-clear { display: none; }
    </style>
    <script type="text/javascript">
    top.fingerprintFlag=false;  
    top.fingerReg=false;
        var ctx = '/zzj';
      try {
        $(function() {
          doFluidLayout();
          $("input").each(function(i){//防止回车提交表单
              $(this).bind("keypress",function(e){
                  if(e.keyCode==13){
                    return false;
                  }
              })
          });
        });
      } catch (e) {
      }
      //con,clearFlag是否清空选项
      function refreshGrid(con, clearFlag) {
        if (!con)
          con = "dataTable";
        try {
          var mfs = document.getElementsByName("mainframe");
          if (mfs.length <= 0)
            mfs = window.parent.document.getElementsByName("mainframe");
          if (mfs.length > 0) {
            $.each(mfs, function(i, mf) {
              if (mf.contentWindow.$) {
                var tempGrid = mf.contentWindow.$("#" + con);
                if($.isFunction(tempGrid.datagrid)){
                    tempGrid.datagrid('reload');
                    if ("undefined"==typeof clearFlag || clearFlag) {
                        tempGrid.datagrid('clearSelections');
                    }
                }
              }
            });
          } else {
            $("#" + con).datagrid('reload');
            $parent("#" + con).datagrid('reload');
            if ("undefined"==typeof clearFlag || clearFlag) {
              $("#" + con).datagrid('clearSelections');
              $parent("#" + con).datagrid('clearSelections');
            }
          }
        } catch (e) {
          var tab = $('#tabs').tabs('getSelected');
          var mfs = $("iframe", tab);
          $.each(mfs, function(i, mf) {
            if (mf.contentWindow.$) {
              mf.contentWindow.$("#" + con).datagrid('reload');
              if ("undefined"==typeof clearFlag || clearFlag) {
                mf.contentWindow.$("#" + con).datagrid('clearSelections');
              }
            }
          });
        }

      } 
    </script>
    <!-- some css fix -->
    <!--[if gte IE 8]>
    <style type="text/css">
    .leftmenu dd span{
        float:none;
    }
    .leftmenu .title{
        height:35px;
    }
    </style> 
    <![endif]-->

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="./static/css/easyui.css">
    <link rel="stylesheet" type="text/css" href="./static/css/my97.css">
    <link rel="stylesheet" type="text/css" href="./static/css/icon.css">
    <script type="text/javascript" src="./static/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="./static/js/jquery.easyui.min.js"></script>
    <link rel="stylesheet" href="./static/css/default.css">
    <script type="text/javascript" src="./static/js/artDialog.source.js"></script>
    <script type="text/javascript" src="./static/js/iframeTools.source.js"></script>
    <script type="text/javascript" src="./static/js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="./static/js/extends.js"></script>
    <script type="text/javascript" src="./static/js/common.js"></script>
    <script type="text/javascript" src="./static/js/cross_browser_fix.js"></script>
    <script type="text/javascript" src="./static/js/global.js"></script>
    <title>酒测/出勤</title>
    <link href="./static/css/zzj_css.css" rel="stylesheet" type="text/css">
    <link href="./static/lib/keyboard/css/keyboard.css" type="text/css" rel="stylesheet" />
    <link href="./static/lib/keyboard/css/jquery-ui.min.css" type="text/css" rel="stylesheet" />
    <script language="javascript" type="text/javascript" src="./static/lib/keyboard/js/jquery.keyboard.js"></script>
    <script language="javascript" type="text/javascript" src="./static/lib/keyboard/js/jquery.keyboard.extension-typing.js"></script>
    <script language="javascript" type="text/javascript" src="./static/lib/keyboard/js/jquery.keyboard.extension-autocomplete.js"></script>
    <script language="javascript" type="text/javascript" src="./static/lib/keyboard/js/bootstrap.min.js"></script>
    <script>
        checkToken();
        var userToken = getCookie("userToken");
        var userInfo;
        var alcohol_check = 0;     
        var alcohol_check_result = 0;
        var win_test_flag = 0;
        var interval;
        // TODO 酒测 ip地址待定 后续根据实际机器地址设置
        var wsaddr = "ws://localhost:8088/rxtx/websocket/test-1";
        var websocket;

        userInfo = JSON.parse(getCookie("userInfo"));
        dutyInfo = JSON.parse(getCookie("dutyInfo"));
        console.log("dutyInfo:");
        console.log(dutyInfo);
        $(document).ready(function() {
            renderTable(dutyInfo);
        });
        



        function StartWebSocket(wsUri) {
            websocket = new WebSocket(wsUri);
            websocket.onopen = function(evt) {
                onOpen(evt);
            };
            websocket.onclose = function(evt) {
                onClose(evt);
            };
            websocket.onmessage = function(evt) {
                onMessage(evt);
            };
            websocket.onerror = function(evt) {
                onError(evt);
            };
        }

        function onOpen(evt) {
            $("#msg").html('<p>酒测状态：<span class="bold">酒测开始</span></p>');
            send('{"event":"1","port":"COM6"}');//打开串口COM6
            doWineTest();
            
        }

        function onClose(evt) {
            send('{"event":"9","port":"COM6"}');//停止酒测 串口COM6
            websocket.close();
        }

        function onMessage(evt) {
            if (typeof evt.data == "string") {
                displayContent(evt.data);
            }
            else {
                alert("非文本消息");
            }
        }

        function onError(evt) {
            //error log
            websocket.close();
        }
        function timerTest(){
            console.log("timerTest")
            if(win_test_flag == 0){
                send('{"event":"2","port":"COM6"}');
            }
        }
        function doWineTest(){
            interval = setInterval('timerTest()', 2000); 
        }

        function send(msg){
            websocket.send(msg);
        }

        function displayContent(msg) {
            if (msg.indexOf("浓度值")==-1){
                $("#msg").html('<p>酒测状态：<span class="bold">'+msg+'</span></p>');
            }
            if (msg.indexOf("浓度值")>-1) {
                var dushu = msg.split(":");
                var wine_test_content = dushu[1];
                alcohol_check_result = Number(wine_test_content);
                if (alcohol_check_result < 20) {
                    win_test_flag = 1;//停止酒测
                    alcohol_check = 1;
                    clearInterval(interval);
                    $("#wineTestContent").text(wine_test_content + "mg/100ml");
                    $("#wineTestResult").text("通过");
                    //显示出勤
                    $("#btn_on").show();
                    $("#msg").html('<p>酒测状态：<span class="bold">通过</span></p>');
                    send('{"event":"9","port":"COM6"}');
                    websocket.close();
                }else{
                    msg = "测试失败,"+msg;
                    $("#msg").html('<p>酒测状态：<span class="bold">'+msg+'</span></p>');
                    setTimeout('send("event":"2","port":"COM6")', 2000);
                }
            }else if (msg.indexOf("失败")>-1) {
                setTimeout('send("event":"2","port":"COM6")', 2000);
            }else if (msg.indexOf("超时")>-1) {
                setTimeout('send("event":"2","port":"COM6")', 2000);
            }
        }


        function renderTable(dutyInfo){
            var table_tpl = '<table id="partsTable_1" width="100%" border="0" cellspacing="0" cellpadding="0" style="margin:auto;">'+
                            '    <tr>'+
                            '        <td width="20%"><label for="crName">交路：</label></td>'+
                            '        <td width="30%">'+
                            '            <span>{{crName}}</span>'+
                            '        </td>'+
                            '        <td rowspan="3" colspan="2">'+
                            '            <img src="./static/images/default_img.jpg" onerror="changeImg(this);" class="img-border radius-none"/>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt"><label for="account">工号：</label></td>'+
                            '        <td>'+
                            '            <span>{{userNo}}</span>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt"><label for="user_view_name">姓名：</label></td>'+
                            '        <td>'+
                            '            <span>{{userViewName}}</span>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td width="20%" class="prompt"><label for="trainTime">发车时间：</label></td>'+
                            '        <td width="30%">'+            
                            '            <span></span>'+
                            '        </td>'+
                            '        <td width="20%" class="prompt"><label for="reptrain">发车车次：</label></td>'+
                            '        <td width="30%" >'+            
                            '            <span></span>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt"><label for="plan_attend_time">出勤时间：</label></td>'+
                            '        <td>'+
                            '            <span>{{attendTime}}</span>'+
                            '        </td>'+
                            '        <td class="prompt"><label for="plan_offWork_time">退勤时间：</label></td>'+
                            '        <td>'+
                            '            <span>{{offWorkTime}}</span>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt"><label for="carNum">车体号：</label></td>'+
                            '        <td>'+
                            '            <span></span>'+
                            '        </td>'+
                            '        <td class="prompt"><label for="track">股道：</label></td>'+
                            '        <td>'+            
                            '            <span></span>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt" for="wineTestResult">酒测结果：</td>'+
                            '        <td class="promptCenter" id="wineTestResult"></td>'+
                            '        <td class="prompt"><label for="wineTestContent">酒精含量：</label></td>'+
                            '        <td name="wineTestContent" value="" id="wineTestContent"></td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt"><label for="parts">钥匙柜：</label></td>'+
                            '        <td><input class="easyui-textbox full qwerty" id="mykey" name="mykey"  />'+
                            '        </td>'+
                            '        <td class="prompt"><label for="reMarks">备注：</label></td>'+
                            '        <td><input class="easyui-textbox full" id="reMarks" name="reMarks" value=""/>'+
                            '        </td>'+
                            '    </tr>'+
                            '</table>';
            table_tpl = table_tpl.replace("{{crName}}",dutyInfo.crName);
            table_tpl = table_tpl.replace("{{userNo}}",userInfo.userName);
            table_tpl = table_tpl.replace("{{userViewName}}",userInfo.userViewName);
            table_tpl = table_tpl.replace("{{userViewName}}",userInfo.userViewName);
            table_tpl = table_tpl.replace("{{attendTime}}",dutyInfo.attentime);
            table_tpl = table_tpl.replace("{{offWorkTime}}",dutyInfo.offtime);
            $("#onDutyDataForm").prepend(table_tpl);
            if(dutyInfo.attendFlag == 1){
                $("#btn_on").hide();   
            }
        }
        var saveLock = 0;
        // console.log(1233)
        document.addEventListener('DOMContentLoaded', function(){
          if(userInfo.positionNameStr.indexOf('司机长')>-1||userInfo.positionNameStr.indexOf('指导司机')>-1){
            $("#btn_on").show()
            $("#btn_alcohol_check").hide()
        }else{
          $("#btn_on").hide()
        }
          
        }, false)
        $(document).on("click", "#btn_on", function(){
          if(userInfo.positionNameStr.indexOf('司机长')>-1||userInfo.positionNameStr.indexOf('指导司机')>-1){

          }else{
            if(alcohol_check==0){
                $parent.messager.alert('提示', '还未进行酒精测试', 'info');
                return;
            }
            if(alcohol_check_result > 20){
                $parent.messager.alert('提示', '酒精测试未通过', 'info');
                return;
            }
          }
            
            $.ajax({
                url:"http://nocm.wzmtr.com:2443/zzj/user/dutyOn",
                type:"POST",
                data:JSON.stringify({"userId":userInfo.userId,"newSchedulingId":dutyInfo.id,"recDate":dutyInfo.recDate,"alcoholTestStatus":"1","alcoholResult":alcohol_check_result}),
                dataType:"json",
                beforeSend: function (request) {
                    request.setRequestHeader("Content-Type", "application/json");
                    request.setRequestHeader("Authorization", userToken);
                },
                success:function (res) {
                    console.log(res)

                    if(res.code == 0){
                        if(dutyInfo.workRecord == null){
                            dutyInfo.workRecord = [];
                        }else{
                        }
                        var workRecordAttend = {"workType":"1","actionTime":res.data};
                        dutyInfo.workRecord.push(workRecordAttend);
                        dutyInfo.attendQuitRecord = {};
                        dutyInfo.attendQuitRecord.attendTime = res.data;
                        dutyInfo.attendFlag = 1;
                        setCookie("dutyInfo",JSON.stringify(dutyInfo));
                    //    location.href = "/zzj/duty_result.html";
                       electron.loadPage('./src/duty_result.html')
                       
                    }else{
                        $parent.messager.alert('提示', res.message, 'info');
                    }
                    
                },
                error:function () {
                   
                }
            });

        });
        $(document).on("click", "#btn_alcohol_check", function(){
            alcohol_check = 1;
            alcohol_check_result = 0;
            console.log(document.getElementById("wineTestContent"));
            console.log(document.getElementById("wineTestResult"));
            //测试酒精
            // displayContent('浓度值:15');
            // wsaddr = wsaddr.replace("localhost",getCookie("clientIP"));
            StartWebSocket(wsaddr);

             //$("#msg").html('<p>酒测状态：<span class="bold">吹气成功</span></p>');
             //$("#wineTestContent").text(0 + "mg/100ml");
             //$("#wineTestResult").text("通过");
        });

    </script>
</head>
<body style="">
<div class="zzj_subpage_wrap">
        <div class="top"><div class="top_left" style="display: flex; justify-content: space-between;"><div>温州市域轨道交通乘务自助终端系统</div>
          <!-- <input style="margin-right: 20px;" type="button" class="btn" id="btn_close" onclick="closeapp()" value="退出系统"/> -->
          <img src="./static/images/cancel.png" onerror="changeImg(this);" onclick="closeapp()"  class="img-border radius-none" style="width: 50px;height: 50px;margin-top: 15px;margin-right: 30px;"/>
        </div>
      
      </div>
        <div class="subpage_main">
        <div id="zhongxin2" class="zzj_loading" style="display:none"></div>
        <div  id="zhongxin">
        <div class="subpage_main_in">
            <div class="text1" style="display: none;">
                <p>错误信息</p>
            </div>
            <div class="table_box">
                <form method="post" id="onDutyDataForm">
                    <table id="onPartsTable" width="100%" border="0" cellspacing="0" cellpadding="0" style="margin:auto;">
<!--                        <tr>
                            <td width="20%">序号</td>
                            <td width="30%">条形码/二维码</td>
                            <td width="20%">备品名称</td>
                            <td width="30%">操作</td>
                        </tr>-->
                    </table>
                </form>
            </div>
            <div  class="msg" id="msg">
            </div>
            <div style="width: 100%;position: absolute;bottom: 150px;">
            <div class="btn_box" >
                <!-- role 1073 1074 1078 -->
                    <!-- dutyMsg=='' -->
                <input type="button" class="btn " id="btn_alcohol_check" value="酒测">
                <input type="button" class="btn" id="btn_on" value="出勤">
                <!-- <input type="button" class="btn" id="btn_last" onclick="gotoIndex()" value="返回首页"/> -->
                <input type="button" class="btn" id="btn_quit" onclick="logout()" value="退出登录"/>
                <!-- <input type="button" class="btn" id="btn_close" onclick="closeapp()" value="退出系统"/> -->
            </div>
          </div>
        </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    function gotoIndex(){
        // location.href = "/zzj/index.html";
        electron.loadPage('./src/index.html')
    }
    // 登出
    function logout() {
        clearCookie("userToken");
        clearCookie("userInfo");
        clearCookie("dutyInfo");
        // location.href="/zzj/login.html";
        electron.loadPage('./src/login.html')
    }
    function closeapp() {
      electron.closePage();
    }
</script>
</body>
</html>