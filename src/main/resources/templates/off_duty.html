<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="ie-stand">
    <style>
        input::-ms-clear { display: none; }
    </style>
    <script type="text/javascript">
    top.fingerprintFlag=false;  
    top.fingerReg=false;
        var ctx = '/wzcs';
      try {
        $(function() {
          doFluidLayout();
          $("input").each(function(i){//防止回车提交表单
              $(this).bind("keypress",function(e){
                  if(e.keyCode==13){
                    return false;
                  }
              })
          });
        });
      } catch (e) {
      }
      //con,clearFlag是否清空选项
      function refreshGrid(con, clearFlag) {
        if (!con)
          con = "dataTable";
        try {
          var mfs = document.getElementsByName("mainframe");
          if (mfs.length <= 0)
            mfs = window.parent.document.getElementsByName("mainframe");
          if (mfs.length > 0) {
            $.each(mfs, function(i, mf) {
              if (mf.contentWindow.$) {
                var tempGrid = mf.contentWindow.$("#" + con);
                if($.isFunction(tempGrid.datagrid)){
                    tempGrid.datagrid('reload');
                    if ("undefined"==typeof clearFlag || clearFlag) {
                        tempGrid.datagrid('clearSelections');
                    }
                }
              }
            });
          } else {
            $("#" + con).datagrid('reload');
            $parent("#" + con).datagrid('reload');
            if ("undefined"==typeof clearFlag || clearFlag) {
              $("#" + con).datagrid('clearSelections');
              $parent("#" + con).datagrid('clearSelections');
            }
          }
        } catch (e) {
          var tab = $('#tabs').tabs('getSelected');
          var mfs = $("iframe", tab);
          $.each(mfs, function(i, mf) {
            if (mf.contentWindow.$) {
              mf.contentWindow.$("#" + con).datagrid('reload');
              if ("undefined"==typeof clearFlag || clearFlag) {
                mf.contentWindow.$("#" + con).datagrid('clearSelections');
              }
            }
          });
        }

      } 
    </script>
    <!-- some css fix -->
    <!--[if gte IE 8]>
    <style type="text/css">
    .leftmenu dd span{
        float:none;
    }
    .leftmenu .title{
        height:35px;
    }
    </style> 
    <![endif]-->

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="./static/css/easyui.css">
    <link rel="stylesheet" type="text/css" href="./static/css/my97.css">
    <link rel="stylesheet" type="text/css" href="./static/css/icon.css">
    <script type="text/javascript" src="./static/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="./static/js/jquery.easyui.min.js"></script>
    <link rel="stylesheet" href="./static/css/default.css">
    <script type="text/javascript" src="./static/js/artDialog.source.js"></script>
    <script type="text/javascript" src="./static/js/iframeTools.source.js"></script>
    <script type="text/javascript" src="./static/js/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="./static/js/extends.js"></script>
    <script type="text/javascript" src="./static/js/common.js"></script>
    <script type="text/javascript" src="./static/js/cross_browser_fix.js"></script>
        <script type="text/javascript" src="./static/js/global.js"></script>
    <title>退勤</title>
    <link href="./static/css/zzj_css.css" rel="stylesheet" type="text/css">
    <!-- <script type="text/javascript" src="./static/js/attendAndOffWork.js"></script> -->
    <link href="./static/lib/keyboard/css/keyboard.css" type="text/css" rel="stylesheet" />
    <link href="./static/lib/keyboard/css/jquery-ui.min.css" type="text/css" rel="stylesheet" />
    <script language="javascript" type="text/javascript" src="./static/lib/keyboard/js/jquery.keyboard.js"></script>
    <script language="javascript" type="text/javascript" src="./static/lib/keyboard/js/jquery.keyboard.extension-typing.js"></script>
    <script language="javascript" type="text/javascript" src="./static/lib/keyboard/js/jquery.keyboard.extension-autocomplete.js"></script>
    <script language="javascript" type="text/javascript" src="./static/lib/keyboard/js/bootstrap.min.js"></script>
    <script>
        checkToken();
        var userToken = getCookie("userToken");
        var userInfo;
        var keyStoreFlag=1;
        userInfo = JSON.parse(getCookie("userInfo"));
        dutyInfo = JSON.parse(getCookie("dutyInfo"));
        console.log("dutyInfo:" + dutyInfo);
        $(document).ready(function() {
            renderTable(userInfo,dutyInfo);
        });

        
        function renderTable(userInfo,dutyInfo){
            var table_tpl = '<table id="partsTable_1" width="100%" border="0" cellspacing="0" cellpadding="0" style="margin:auto;">'+
                            '    <tr>'+
                            '        <td width="20%"><label for="crName">交路：</label></td>'+
                            '        <td width="30%">'+
                            '            <span>{{crName}}</span>'+
                            '        </td>'+
                            '        <td rowspan="3" colspan="2">'+
                            '            <img src="./static/images/default_img.jpg" onerror="changeImg(this);" class="img-border radius-none"/>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt"><label for="account">工号：</label></td>'+
                            '        <td>'+
                            '            <span>{{userNo}}</span>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt"><label for="user_view_name">姓名：</label></td>'+
                            '        <td>'+
                            '            <span>{{userViewName}}</span>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt"><label for="plan_attend_time">出勤时间：</label></td>'+
                            '        <td>'+
                            '            <span>{{attendTime}}</span>'+
                            '        </td>'+
                            '        <td class="prompt"><label for="plan_offWork_time">退勤时间：</label></td>'+
                            '        <td>'+
                            '            <span>{{offWorkTime}}</span>'+
                            '        </td>'+
                            '    </tr>'+
                            '    <tr>'+
                            '        <td class="prompt"><label for="parts">钥匙柜：</label></td>'+
                            '        <td><input class="easyui-textbox full qwerty" id="mykey" name="mykey"  />'+
                            '        </td>'+
                            '        <td class="prompt"><label for="reMarks">备注：</label></td>'+
                            '        <td><input class="easyui-textbox full" id="reMarks" name="reMarks" value=""/>'+
                            '            <img src="./static/images/keyboard.png" class="img-border radius-none"/>'+
                            '        </td>'+
                            '    </tr>'+
                            '</table>';
            table_tpl = table_tpl.replace("{{crName}}",dutyInfo.crName);
            table_tpl = table_tpl.replace("{{userNo}}",userInfo.userName);
            table_tpl = table_tpl.replace("{{userViewName}}",userInfo.userViewName);
            table_tpl = table_tpl.replace("{{userViewName}}",userInfo.userViewName);
            table_tpl = table_tpl.replace("{{attendTime}}",dutyInfo.attentime);
            table_tpl = table_tpl.replace("{{offWorkTime}}",dutyInfo.offtime);
            $("#onDutyDataForm").prepend(table_tpl);
        }

        /*
function checkUserKey(){
            if(dutyInfo.crName.indexOf("晚") > -1){
                //判断钥匙是否存
                $.ajax({
                    url:"/zzj/user/checkKeyStore",
                    type:"Get",
                    data:JSON.stringify({"userId":userInfo.userId,"newSchedulingId":dutyInfo.id}),
                    dataType:"json",
                    beforeSend: function (request) {
                        request.setRequestHeader("Content-Type", "application/json");
                        request.setRequestHeader("Authorization", userToken);
                    },
                    success:function (res) {
                        console.log(res)

                        if(res.code == 0){
                            if(res.data.checkRes == 0){
                                keyStoreFlag = 0;
                            }else {
                                //$("#mykey").value =
                            }
                        }else{
                            $parent.messager.alert('提示', res.message, 'info');
                        }

                    },
                    error:function () {

                    }
                });
            }
        }
        */

    </script>
</head>
<body style="">
<div class="zzj_subpage_wrap">
        <div class="top"><div class="top_left">温州市域轨道交通乘务自助终端系统</div></div>
        <div class="subpage_main">
        <div id="zhongxin2" class="zzj_loading" style="display:none"></div>
        <div  id="zhongxin">
        <div class="subpage_main_in">
            <div class="text1" style="display: none;">
                <p>错误信息</p>
            </div>
            <div class="table_box">
                <form method="post" id="onDutyDataForm">
                    <table id="onPartsTable" width="100%" border="0" cellspacing="0" cellpadding="0" style="margin:auto;">
<!--                        <tr>
                            <td width="20%">序号</td>
                            <td width="30%">条形码/二维码</td>
                            <td width="20%">备品名称</td>
                            <td width="30%">操作</td>
                        </tr>-->
                    </table>
                </form>
            </div>
            <div  class="msg" id="msg"></div>
            <div class="btn_box">
                <input type="button" class="btn" id="btn_off" onclick="do_off()" value="退勤">
                <!-- <input type="button" class="btn" id="btn_last" onclick="gotoIndex()" value="返回首页"/> -->
                <input type="button" class="btn" id="btn_quit" onclick="logout()" value="退出登录"/>
            </div>
        </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    function do_off(){
      console.log(dutyInfo)
      if(dutyInfo.isSpecialType!=1){
        $.ajax({
                url:"http://nocm.wzmtr.com:2443/zzj/user/dutyOff",
                type:"POST",
                data:JSON.stringify({"userId":userInfo.userId,"newSchedulingId":dutyInfo.id}),
                dataType:"json",
                beforeSend: function (request) {
                    request.setRequestHeader("Content-Type", "application/json");
                    request.setRequestHeader("Authorization", userToken);
                },
                success:function (res) {
                    console.log(res)
                    if(res.code == 0){
                        // if(dutyInfo.attendQuitRecord){
                        //     dutyInfo.attendQuitRecord.quitTime = res.data;
                        // }else{
                        //     dutyInfo.attendQuitRecord = {};
                        //     dutyInfo.attendQuitRecord.quitTime = res.data;
                        // }
                        var workRecordQuit = {"workType":"2","actionTime":res.data};
                        dutyInfo.workRecord.push(workRecordQuit);
                        if(dutyInfo.attendQuitRecord == null){
                            dutyInfo.attendQuitRecord = {};
                        }
                        dutyInfo.attendQuitRecord.quitTime = res.data;
                        dutyInfo.quitFlag = 1;
                        setCookie("dutyInfo",JSON.stringify(dutyInfo));
                        gotoIndex()
                    //    location.href = "/zzj/off_result.html";                  
                    }else{
                        $parent.messager.alert('提示', res.message, 'info');
                    }      
                },
                error:function () {
                   
                }
            });
      }else{
        electron.loadPage('./src/off_result.html')
      }
      
    
    }
    function gotoIndex(){
        // location.href = "/zzj/index.html";
        electron.loadPage('./src/index.html')
    }
    // 登出
    function logout() {
        clearCookie("userToken");
        clearCookie("userInfo");
        clearCookie("dutyInfo");
        // location.href="/zzj/login.html";
        electron.loadPage('./src/login.html')
    }
</script>
</body>
</html>